---
phase: 06-database-foundation
plan: 02
type: execute
wave: 1
depends_on:
  - 06-01
files_modified:
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "System can track when each meal was used across multiple weeks"
    - "Usage history entries are linked to specific meals via foreign key"
    - "Deleting a meal automatically deletes its usage history"
    - "UsageHistory becomes the primary recency source for future plan logic"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "UsageHistory model definition"
      contains: "model UsageHistory"
    - path: "prisma/schema.prisma"
      provides: "Cascading delete constraint"
      contains: "onDelete: Cascade"
  key_links:
    - from: "UsageHistory model"
      to: "Meal model"
      via: "@relation with mealId foreign key"
      pattern: "meal.*@relation.*mealId.*onDelete: Cascade"
    - from: "UsageHistory indexes"
      to: "Query performance"
      via: "Composite indexes for filtered queries"
      pattern: "@@index\\(\\[userId, usedDate\\]\\)"
---

<objective>
Create UsageHistory model to track when meals are used in weekly plans, enabling smart variety logic in Phase 7.

Purpose: Replace the simple lastUsed timestamp with detailed usage tracking that records EVERY time a meal is used. This enables sophisticated variety rules (avoid meals from last 2 weeks, detect consecutive week patterns) without complex migration of existing data.

Output: UsageHistory model in schema.prisma with proper relations, cascade delete, and composite indexes.
</objective>

<execution_context>
@/Users/seblju/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seblju/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-database-foundation/06-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Add UsageHistory model to schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the UsageHistory model definition to schema.prisma (after the Meal and WeeklyPlan models):

```prisma
model UsageHistory {
  id            String   @id @default(cuid())
  meal          Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  mealId        String
  userId        String
  usedDate      DateTime @default(now())
  weekStartDate DateTime
  createdAt     DateTime @default(now())

  @@index([userId, usedDate])
  @@index([mealId])
}
```

Also add the reverse relation field on `Meal`:

```prisma
model Meal {
  // ...
  usageHistory UsageHistory[]
}
```

CRITICAL:
- Use `onDelete: Cascade` in the @relation directive (if user deletes meal, history entries auto-delete)
- Store userId directly (not just via meal relation) for efficient user-scoped queries
- usedDate defaults to now() for when the meal was added to a plan
- weekStartDate stores the Monday date (ISO week start) for week-based queries
- Add composite index [userId, usedDate] for "recent usage" queries
- Add single index [mealId] for reverse lookups (show usage history for a meal)

Why this structure:
- Foreign key (mealId) prevents orphaned records via cascade delete
- Composite indexes support Phase 7 queries: "meals used in last 2 weeks for userId X"
- weekStartDate enables "was this meal used 3 weeks in a row?" queries
- createdAt tracks when the history entry was created (audit trail)
- `lastUsed` can be deprecated once Phase 7 logic reads UsageHistory end-to-end
  </action>
  <verify>
Run `npx prisma format` to validate schema syntax.
Check schema contains:
- UsageHistory model definition
- @relation with onDelete: Cascade
- Two @@index directives ([userId, usedDate] and [mealId])
  </verify>
  <done>
UsageHistory model added to schema with proper relations, cascade delete, and composite indexes. Schema passes validation.
  </done>
</task>

</tasks>

<verification>
1. Run `npx prisma format` - should succeed
2. Check model exists: `grep -A 12 "model UsageHistory" prisma/schema.prisma`
3. Check cascade delete: `grep "onDelete: Cascade" prisma/schema.prisma`
4. Check indexes: `grep -A 1 "@@index" prisma/schema.prisma | grep -E "userId.*usedDate|mealId"`
</verification>

<success_criteria>
- UsageHistory model exists in schema
- Model has foreign key to Meal with onDelete: Cascade
- Model has userId, usedDate, weekStartDate fields
- Composite index [userId, usedDate] exists
- Index [mealId] exists
- Schema passes Prisma validation
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-foundation/06-02-SUMMARY.md` following the standard summary template.
</output>
