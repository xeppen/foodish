---
phase: 06-database-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified:
  - prisma/migrations/
  - node_modules/.prisma/
autonomous: true

must_haves:
  truths:
    - "Database schema includes Rating and Complexity enums"
    - "Database schema includes UsageHistory table with foreign keys"
    - "Existing meals in production continue to work with null ratings/complexity"
    - "Prisma Client generates TypeScript types for new enums"
  artifacts:
    - path: "prisma/migrations/[timestamp]_add_ratings_complexity_variety/migration.sql"
      provides: "SQL migration file"
      contains: "CREATE TYPE"
    - path: "node_modules/.prisma/client/index.d.ts"
      provides: "Generated TypeScript types"
      contains: "export enum Rating"
  key_links:
    - from: "Migration SQL"
      to: "PostgreSQL database"
      via: "prisma migrate dev execution"
      pattern: "CREATE TYPE.*Rating.*ENUM"
    - from: "Schema changes"
      to: "Prisma Client types"
      via: "prisma generate"
      pattern: "export enum Rating"
---

<objective>
Apply schema changes to database and generate updated Prisma Client with new types.

Purpose: Execute the migration to add enums, fields, and UsageHistory table to production database. Verify backward compatibility so existing code continues working during deployment window.

Output: Applied migration files, updated Prisma Client with Rating/Complexity types, verified backward compatibility.
</objective>

<execution_context>
@/Users/seblju/.claude/get-shit-done/workflows/execute-plan.md
@/Users/seblju/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-database-foundation/06-RESEARCH.md
@prisma/schema.prisma
@lib/actions/plans.ts
</context>

<tasks>

<task type="auto">
  <name>Create and review migration</name>
  <files>prisma/migrations/</files>
  <action>
Run the following commands to create the migration (DO NOT apply yet):

```bash
npx prisma migrate dev --create-only --name add_ratings_complexity_variety
```

This creates a migration file in `prisma/migrations/[timestamp]_add_ratings_complexity_variety/migration.sql`.

Review the generated SQL to verify:
1. CREATE TYPE statements for Rating and Complexity enums appear FIRST
2. ALTER TABLE Meal statements add nullable columns (no NOT NULL constraint)
3. ALTER TABLE Meal statements add the usageHistory relation
4. CREATE TABLE UsageHistory statement includes foreign key constraint with ON DELETE CASCADE
5. CREATE INDEX statements for all composite indexes ([userId, rating], [userId, complexity], [userId, usedDate], [mealId])

CRITICAL VERIFICATION:
- Ensure NO @default values in ALTER TABLE statements (would trigger P3018 error)
- Ensure columns are nullable (allows existing rows to have NULL for new fields)
- Ensure ON DELETE CASCADE in UsageHistory foreign key

If migration SQL looks incorrect, abort and fix schema.prisma before applying.

Read the generated migration.sql file and output key sections for verification.
  </action>
  <verify>
Read `prisma/migrations/[timestamp]_add_ratings_complexity_variety/migration.sql` and verify:
- Contains CREATE TYPE "Rating" and CREATE TYPE "Complexity"
- Contains ALTER TABLE "Meal" ADD COLUMN "rating" "Rating" (no DEFAULT, nullable)
- Contains CREATE TABLE "UsageHistory" with ON DELETE CASCADE
- Contains CREATE INDEX statements for composite indexes
  </verify>
  <done>
Migration file created and reviewed. SQL verified to be backward-compatible (nullable fields, no defaults, cascade delete).
  </done>
</task>

<task type="auto">
  <name>Apply migration and generate client</name>
  <files>prisma/migrations/, node_modules/.prisma/</files>
  <action>
Apply the migration to the database:

```bash
npx prisma migrate dev
```

This will:
1. Apply the migration.sql to the connected database (development or production based on DATABASE_URL)
2. Automatically run `npx prisma generate` to regenerate Prisma Client with new types

After successful migration, verify the generated types:

```bash
grep -A 5 "export enum Rating" node_modules/.prisma/client/index.d.ts
grep -A 5 "export enum Complexity" node_modules/.prisma/client/index.d.ts
```

Should see TypeScript enum definitions with THUMBS_DOWN/NEUTRAL/THUMBS_UP and SIMPLE/MEDIUM/COMPLEX values.

IMPORTANT: If migration fails with P3018 error ("enum values must be committed"), this indicates schema has @default on enum fields. This should NOT happen (schema is nullable), but if it does, rollback and fix schema.prisma.
  </action>
  <verify>
Run verification commands:
1. `npx prisma db execute --stdin <<< "SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'Meal' AND column_name IN ('rating', 'complexity');"` - should show nullable columns
2. `grep "export enum Rating" node_modules/.prisma/client/index.d.ts` - should find TypeScript enum
3. Test query: Create a simple script that reads all meals and logs them (should succeed even with null rating/complexity)
  </verify>
  <done>
Migration applied successfully. Database schema updated with enums and UsageHistory table. Prisma Client regenerated with new TypeScript types. Existing meals continue to work with null values.
  </done>
</task>

<task type="auto">
  <name>Verify backward compatibility</name>
  <files>lib/actions/plans.ts</files>
  <action>
Test that existing plan generation code works with the new schema:

1. Run the development server: `npm run dev`
2. Navigate to the app in browser
3. Trigger plan generation (as authenticated user)
4. Verify that:
   - Plans generate successfully
   - Existing meals display correctly (no errors about null rating/complexity)
   - No TypeScript errors in server actions
   - Console shows no Prisma query errors

If plan generation fails, check:
- Are there any queries filtering by `rating: { not: null }`? (This would exclude all existing meals - BAD)
- Are there orderBy clauses that don't handle nulls? (Should use `{ rating: { sort: 'desc', nulls: 'last' } }`)

The existing code in lib/actions/plans.ts should NOT reference rating or complexity yet (those are Phase 7+ features), so it should work unchanged.

If errors occur, document them in the summary for Phase 7 planning.
  </action>
  <verify>
Manual verification steps:
1. Visit http://localhost:3000
2. Sign in with test account
3. Click "Generera plan" (generate plan)
4. Verify plan displays 5 meals for Mon-Fri
5. Check browser console and terminal logs for errors
6. Verify swap functionality still works (click swap on any day)
  </verify>
  <done>
Backward compatibility verified. Existing plan generation and swap functionality work correctly with new schema. Existing meals have null rating/complexity, and application handles this gracefully (no queries filter on these fields yet).
  </done>
</task>

</tasks>

<verification>
1. Migration files exist: `ls prisma/migrations/ | grep add_ratings_complexity_variety`
2. Database schema updated: `npx prisma db execute --stdin <<< "SELECT table_name FROM information_schema.tables WHERE table_name = 'UsageHistory';"` (should return UsageHistory)
3. Prisma Client has new types: `grep "Rating\|Complexity" node_modules/.prisma/client/index.d.ts` (should find enum exports)
4. Existing functionality works: Run app and test plan generation/swap
</verification>

<success_criteria>
- Migration file created in prisma/migrations/ with correct SQL
- Migration applied successfully to database (no P3018 errors)
- Database has Rating and Complexity enum types
- Meal table has rating and complexity columns (nullable)
- UsageHistory table exists with foreign key and cascade delete
- Composite indexes created for filtered queries
- Prisma Client regenerated with Rating/Complexity TypeScript enums
- Existing plan generation and swap functionality work without errors
- Existing meals display correctly with null ratings/complexity
</success_criteria>

<output>
After completion, create `.planning/phases/06-database-foundation/06-03-SUMMARY.md` following the standard summary template.
</output>
